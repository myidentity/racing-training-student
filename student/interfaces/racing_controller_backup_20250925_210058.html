<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Racing Controller - Interactive Training System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Apple-inspired color palette */
            --bg-gradient: linear-gradient(135deg, #5C7CFA 0%, #C778DD 50%, #F8B500 100%);
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.25);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            --text-primary: #FFFFFF;
            --text-secondary: rgba(255, 255, 255, 0.9);
            --text-tertiary: rgba(255, 255, 255, 0.75);
            --success-color: #34D399;
            --warning-color: #FBBF24;
            --danger-color: #F87171;
            --info-color: #60A5FA;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated background orbs */
        body::before, body::after {
            content: '';
            position: fixed;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.5;
            animation: float 20s infinite;
        }

        body::before {
            width: 600px;
            height: 600px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            top: -200px;
            right: -200px;
        }

        body::after {
            width: 500px;
            height: 500px;
            background: linear-gradient(135deg, #f093fb, #f5576c);
            bottom: -200px;
            left: -200px;
            animation-delay: 10s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -30px) rotate(120deg); }
            66% { transform: translate(-20px, 20px) rotate(240deg); }
        }

        /* Connection Status Bar */
        .connection-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--warning-color);
            z-index: 10000;
            transition: all 0.3s ease;
        }

        .connection-bar.connecting {
            background: var(--warning-color);
            animation: pulse-bar 1.5s infinite;
        }

        .connection-bar.connected {
            background: var(--success-color);
        }

        .connection-bar.error {
            background: var(--danger-color);
        }

        @keyframes pulse-bar {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Registration Modal with Glassmorphism */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9000;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .modal-overlay.hidden {
            display: none;
        }

        .registration-modal {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--glass-shadow);
            animation: slideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .modal-header h2 {
            color: var(--text-primary);
            font-size: 2em;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 10px;
        }

        /* Version display */
        .version-display {
            position: absolute;
            top: -10px;
            right: -10px;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            padding: 4px 10px;
            font-size: 0.75em;
            color: #667eea;
            font-family: monospace;
        }

        .version-display .version-number {
            font-weight: bold;
        }

        .version-display .update-time {
            color: var(--text-secondary);
            margin-left: 8px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-control.error {
            border-color: var(--danger-color);
        }

        /* Country Autocomplete */
        .autocomplete-wrapper {
            position: relative;
        }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 10px 10px;
            z-index: 1000;
            display: none;
        }

        .autocomplete-list.active {
            display: block;
        }

        .autocomplete-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }

        .country-flag {
            font-size: 1.2em;
        }

        .error-message {
            color: var(--danger-color);
            font-size: 0.85em;
            margin-top: 5px;
            display: none;
        }

        .btn-submit {
            width: 100%;
            padding: 16px 24px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .btn-submit::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.6s;
        }

        .btn-submit:hover:not(:disabled)::before {
            left: 100%;
        }

        .btn-submit:hover:not(:disabled) {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        .btn-submit:active {
            transform: translateY(0);
        }

        .btn-submit:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        /* Connection Warning */
        .connection-warning {
            background: linear-gradient(135deg, #ff6b6b, #ff4444);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 0.9em;
        }

        .connection-warning.hidden {
            display: none;
        }

        /* Waiting Room */
        .waiting-room {
            min-height: 100vh;
            padding: 20px;
            display: none;
        }

        .waiting-room.active {
            display: block;
        }

        .waiting-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .waiting-header {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .queue-position {
            display: inline-block;
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.5em;
            font-weight: bold;
            margin: 20px 0;
            box-shadow: 0 5px 20px rgba(255, 140, 0, 0.3);
        }

        .queue-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .info-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .info-card .label {
            color: var(--text-secondary);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .active-racers {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .racer-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .racer-card {
            background: linear-gradient(135deg, #e0f2fe, #ddd6fe);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            position: relative;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .racer-card.active {
            border-color: var(--success-color);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.3);
        }

        .racer-card.empty {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border: 2px dashed #ccc;
        }

        .car-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .racer-name {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .racer-country {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        /* Control Panel (Active State) */
        .control-panel {
            display: none;
            padding: 20px;
        }

        .control-panel.active {
            display: block;
        }

        .control-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .parameter-controls {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--glass-shadow);
        }

        .parameter-controls h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.8em;
            font-weight: 700;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            letter-spacing: -0.5px;
        }

        .slider-group {
            margin-bottom: 35px; /* Increased spacing for touch */
            position: relative;
            /* Add touch area padding */
            padding: 8px 0;
        }

        /* Touch-friendly enhancements */
        @media (pointer: coarse) {
            .slider-group {
                margin-bottom: 40px;
                padding: 10px 0;
            }
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .slider-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1em;
            letter-spacing: -0.3px;
        }

        .slider-value {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: var(--text-primary);
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 700;
            min-width: 60px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(255, 255, 255, 0.1);
        }

        .slider {
            width: 100%;
            height: 12px; /* Increased from 6px for touch */
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            outline: none;
            -webkit-appearance: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            /* Touch optimizations */
            touch-action: none; /* Prevent scrolling when dragging */
            -webkit-tap-highlight-color: transparent;
            cursor: pointer;
        }

        .slider:hover {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.15);
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 32px; /* Increased from 20px - Apple recommends 44px min touch target */
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25), 0 0 0 0 rgba(255, 255, 255, 0.4);
            transition: all 0.2s ease; /* Faster response */
            position: relative;
            z-index: 2;
        }

        /* Larger touch target on mobile */
        @media (pointer: coarse) {
            .slider::-webkit-slider-thumb {
                width: 40px;
                height: 40px;
            }
        }

        .slider::-webkit-slider-thumb:hover,
        .slider::-webkit-slider-thumb:active {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.15);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3), 0 0 0 10px rgba(255, 255, 255, 0.15);
        }

        .slider::-moz-range-thumb {
            width: 32px; /* Increased from 20px */
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            transition: all 0.2s ease;
        }

        @media (pointer: coarse) {
            .slider::-moz-range-thumb {
                width: 40px;
                height: 40px;
            }
        }



        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @media (max-width: 768px) {
            .racer-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Lock Overlay Styles */
        .lock-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            z-index: 1000;
        }

        .lock-overlay.active {
            display: flex;
        }

        .lock-message {
            background: linear-gradient(135deg, #1a202c, #2d3748);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 2px solid #f6ad55;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        .lock-icon {
            font-size: 4em;
            margin-bottom: 20px;
            animation: lock-pulse 2s infinite;
        }

        @keyframes lock-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .lock-text {
            font-size: 1.5em;
            color: #f6ad55;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .lock-subtext {
            font-size: 1em;
            color: #cbd5e0;
            opacity: 0.8;
        }

        /* Submit Button Enhanced Styles */
        #submitButton {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            transform: translateY(0);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }

        #submitButton:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 255, 136, 0.4);
        }

        #submitButton:active:not(:disabled) {
            transform: translateY(0);
        }

        #submitButton:disabled {
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: none;
        }

        /* Submit Status Feedback */
        #submitStatus {
            min-height: 20px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        /* Algorithm Selector Enhanced */
        #algorithmSelect {
            width: 100%;
            padding: 12px;
            border: 2px solid #4a5568;
            border-radius: 10px;
            background: #1a202c;
            color: #e2e8f0;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        #algorithmSelect:hover:not(:disabled) {
            border-color: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        #algorithmSelect:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }

        #algorithmSelect:disabled {
            cursor: not-allowed;
            opacity: 0.5;
            border-color: #4a5568;
        }

        #algorithmSelect option {
            background: #2d3748;
            color: #e2e8f0;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="connection-bar" id="connectionBar"></div>

    <!-- Registration Modal -->
    <div class="modal-overlay" id="registrationModal">
        <div class="registration-modal">
            <div class="modal-header">
                <!-- Version display -->
                <div class="version-display">
                    <span class="version-number">v1.4.0</span>
                    <span class="update-time" id="updateTime"></span>
                </div>
                <div style="font-size: 3em; margin-bottom: 20px;">🏎️</div>
                <h2>Join Racing Session</h2>
                <p style="color: var(--text-secondary);">Register to participate in the training</p>
            </div>

            <!-- Connection Warning -->
            <div class="connection-warning hidden" id="connectionWarning">
                ⚠️ Cannot connect to Firebase. Please check your internet connection.
            </div>

            <form id="registrationForm">
                <div class="form-group">
                    <label for="studentName">Full Name</label>
                    <input type="text" id="studentName" class="form-control" placeholder="Enter your full name" required>
                    <div class="error-message" id="nameError">Please enter your full name</div>
                </div>

                <div class="form-group">
                    <label for="studentCountry">Country</label>
                    <div class="autocomplete-wrapper">
                        <input type="text" id="studentCountry" class="form-control" placeholder="Type your country name..." required>
                        <div class="autocomplete-list" id="countryList"></div>
                    </div>
                    <div class="error-message" id="countryError">Please select your country</div>
                </div>

                <div class="form-group">
                    <label for="experience">Experience Level (Optional)</label>
                    <select id="experience" class="form-control">
                        <option value="beginner">Beginner</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>

                <button type="submit" class="btn-submit" id="submitBtn">
                    Join Waiting Room
                </button>
            </form>
        </div>
    </div>

    <!-- Waiting Room -->
    <div class="waiting-room" id="waitingRoom">
        <div class="waiting-container">
            <div class="waiting-header">
                <h1>Waiting Room</h1>
                <div class="queue-position">
                    Position in Queue: <span id="queuePosition">-</span>
                </div>
                <p style="color: var(--text-secondary); margin-top: 20px;">
                    Please wait for instructor approval. You'll be notified when a car becomes available.
                </p>
            </div>

            <div class="queue-info">
                <div class="info-card">
                    <div class="value" id="waitingCount">0</div>
                    <div class="label">Students Waiting</div>
                </div>
                <div class="info-card">
                    <div class="value" id="activeCount">0</div>
                    <div class="label">Active Racers</div>
                </div>
                <div class="info-card">
                    <div class="value" id="estimatedWait">-</div>
                    <div class="label">Est. Wait Time</div>
                </div>
            </div>

            <div class="active-racers">
                <h2>🏁 Current Active Racers</h2>
                <div class="racer-grid" id="racerGrid">
                    <!-- Car 1 -->
                    <div class="racer-card empty" data-car="1">
                        <div class="car-icon">🏎️</div>
                        <div class="racer-name">Car 1</div>
                        <div class="racer-country">Empty</div>
                    </div>
                    <!-- Car 2 -->
                    <div class="racer-card empty" data-car="2">
                        <div class="car-icon">🏎️</div>
                        <div class="racer-name">Car 2</div>
                        <div class="racer-country">Empty</div>
                    </div>
                    <!-- Car 3 -->
                    <div class="racer-card empty" data-car="3">
                        <div class="car-icon">🏎️</div>
                        <div class="racer-name">Car 3</div>
                        <div class="racer-country">Empty</div>
                    </div>
                    <!-- Car 4 -->
                    <div class="racer-card empty" data-car="4">
                        <div class="car-icon">🏎️</div>
                        <div class="racer-name">Car 4</div>
                        <div class="racer-country">Empty</div>
                    </div>
                    <!-- Car 5 -->
                    <div class="racer-card empty" data-car="5">
                        <div class="car-icon">🏎️</div>
                        <div class="racer-name">Car 5</div>
                        <div class="racer-country">Empty</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Control Panel (Active Racing) -->
    <div class="control-panel" id="controlPanel">
        <div class="control-container">
            <div class="parameter-controls">
                <h2>🎮 Racing Parameters - Car <span id="carNumber">-</span></h2>

                <!-- Algorithm Display (Pure Pursuit Only) -->
                <div class="algorithm-selection" style="margin-bottom: 25px; padding: 20px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
                    <div style="color: var(--text-primary); font-weight: 700; font-size: 1.2em; margin-bottom: 10px; letter-spacing: -0.3px;">
                        🎯 Control Algorithm: Pure Pursuit
                    </div>
                    <div style="font-size: 0.9em; color: var(--text-secondary); font-style: italic;">
                        💡 Adjust the parameters below to control how your car follows the racing line
                    </div>
                    <!-- Hidden select to maintain compatibility -->
                    <select id="algorithmSelect" style="display: none;">
                        <option value="pure_pursuit" selected>Pure Pursuit Controller</option>
                    </select>
                </div>

                <!-- Pure Pursuit Parameters Section -->
                <div class="param-section" data-algorithm="pure_pursuit">
                    <!-- Lookahead Parameters for Pure Pursuit -->
                    <div style="margin-bottom: 20px; padding: 20px; background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                        <h4 style="color: var(--text-primary); margin-bottom: 15px; font-weight: 700; letter-spacing: -0.3px;">🎯 Pure Pursuit Parameters</h4>

                        <div class="slider-group">
                            <div class="slider-label">
                                <span class="slider-name" title="Look further ahead = Smoother racing! 🎯">Lookahead Distance (m)</span>
                                <span class="slider-value" id="lookaheadValue">2.0</span>
                            </div>
                            <input type="range" class="slider" id="lookaheadSlider" min="0.3" max="15.0" step="0.1" value="2.0">
                        </div>

                        <div class="slider-group">
                            <div class="slider-label">
                                <span class="slider-name" title="Amplify the lookahead effect! 💪">Lookahead Gain</span>
                                <span class="slider-value" id="lookaheadGainValue">1.0</span>
                            </div>
                            <input type="range" class="slider" id="lookaheadGainSlider" min="0.2" max="10.0" step="0.1" value="1.0">
                        </div>

                        <div class="slider-group">
                            <div class="slider-label">
                                <span class="slider-name" title="Minimum lookahead for tight turns">Min Lookahead (m)</span>
                                <span class="slider-value" id="minLookaheadValue">2.0</span>
                            </div>
                            <input type="range" class="slider" id="minLookaheadSlider" min="0.2" max="10.0" step="0.1" value="2.0">
                        </div>

                        <div class="slider-group">
                            <div class="slider-label">
                                <span class="slider-name" title="Maximum lookahead for straights">Max Lookahead (m)</span>
                                <span class="slider-value" id="maxLookaheadValue">3.3</span>
                            </div>
                            <input type="range" class="slider" id="maxLookaheadSlider" min="0.4" max="20.0" step="0.1" value="3.3">
                        </div>

                        <div class="slider-group">
                            <div class="slider-label">
                                <span class="slider-name" title="Bigger = Less precise but faster! 🎪">Waypoint Tolerance (m)</span>
                                <span class="slider-value" id="waypointToleranceValue">2.5</span>
                            </div>
                            <input type="range" class="slider" id="waypointToleranceSlider" min="0.5" max="25.0" step="0.5" value="2.5">
                        </div>
                    </div>
                </div>


                <!-- Speed Parameters -->
                <div style="margin-bottom: 20px; padding: 20px; background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <h4 style="color: var(--text-primary); margin-bottom: 15px; font-weight: 700; letter-spacing: -0.3px;">🏁 Speed Control</h4>

                    <div class="slider-group">
                        <div class="slider-label">
                            <span class="slider-name" title="Higher speeds = Faster lap times! 🚀">Target Speed (m/s)</span>
                            <span class="slider-value" id="targetSpeedValue">1.0</span>
                        </div>
                        <input type="range" class="slider" id="targetSpeedSlider" min="0.1" max="5.0" step="0.1" value="1.0">
                    </div>

                    <div class="slider-group">
                        <div class="slider-label">
                            <span class="slider-name" title="Minimum speed for turns">Min Speed (m/s)</span>
                            <span class="slider-value" id="minSpeedValue">0.8</span>
                        </div>
                        <input type="range" class="slider" id="minSpeedSlider" min="0.04" max="2.0" step="0.02" value="0.8">
                    </div>

                    <div class="slider-group">
                        <div class="slider-label">
                            <span class="slider-name" title="Push the limits! Max speed on straights">Max Speed (m/s)</span>
                            <span class="slider-value" id="maxSpeedValue">1.2</span>
                        </div>
                        <input type="range" class="slider" id="maxSpeedSlider" min="0.16" max="8.0" step="0.1" value="1.2">
                    </div>

                    <div class="slider-group">
                        <div class="slider-label">
                            <span class="slider-name" title="Spin to win! Maximum turn rate 🌀">Max Angular Velocity (rad/s)</span>
                            <span class="slider-value" id="maxAngularValue">1.5</span>
                        </div>
                        <input type="range" class="slider" id="maxAngularSlider" min="0.3" max="15.0" step="0.1" value="1.5">
                    </div>
                </div>

                <!-- Submit Button and Lock Status -->
                <div class="submit-section" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #2d3748;">
                    <div id="lockStatus" style="display: none; background: #f6ad55; color: #1a202c; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-weight: bold;">
                        🔒 Parameters LOCKED by Supervisor - No changes allowed
                    </div>
                    <button id="submitButton" class="submit-btn" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #00ff88, #00bbff); color: #1a202c; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                        📤 Submit Parameters
                    </button>
                    <div id="submitStatus" style="margin-top: 10px; text-align: center; color: #00ff88; font-size: 14px;"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>

        // Complete list of all countries with flags
        const countries = [
            { name: "Afghanistan", flag: "🇦🇫" },
            { name: "Albania", flag: "🇦🇱" },
            { name: "Algeria", flag: "🇩🇿" },
            { name: "Andorra", flag: "🇦🇩" },
            { name: "Angola", flag: "🇦🇴" },
            { name: "Antigua and Barbuda", flag: "🇦🇬" },
            { name: "Argentina", flag: "🇦🇷" },
            { name: "Armenia", flag: "🇦🇲" },
            { name: "Australia", flag: "🇦🇺" },
            { name: "Austria", flag: "🇦🇹" },
            { name: "Azerbaijan", flag: "🇦🇿" },
            { name: "Bahamas", flag: "🇧🇸" },
            { name: "Bahrain", flag: "🇧🇭" },
            { name: "Bangladesh", flag: "🇧🇩" },
            { name: "Barbados", flag: "🇧🇧" },
            { name: "Belarus", flag: "🇧🇾" },
            { name: "Belgium", flag: "🇧🇪" },
            { name: "Belize", flag: "🇧🇿" },
            { name: "Benin", flag: "🇧🇯" },
            { name: "Bhutan", flag: "🇧🇹" },
            { name: "Bolivia", flag: "🇧🇴" },
            { name: "Bosnia and Herzegovina", flag: "🇧🇦" },
            { name: "Botswana", flag: "🇧🇼" },
            { name: "Brazil", flag: "🇧🇷" },
            { name: "Brunei", flag: "🇧🇳" },
            { name: "Bulgaria", flag: "🇧🇬" },
            { name: "Burkina Faso", flag: "🇧🇫" },
            { name: "Burundi", flag: "🇧🇮" },
            { name: "Cambodia", flag: "🇰🇭" },
            { name: "Cameroon", flag: "🇨🇲" },
            { name: "Canada", flag: "🇨🇦" },
            { name: "Cape Verde", flag: "🇨🇻" },
            { name: "Central African Republic", flag: "🇨🇫" },
            { name: "Chad", flag: "🇹🇩" },
            { name: "Chile", flag: "🇨🇱" },
            { name: "China", flag: "🇨🇳" },
            { name: "Colombia", flag: "🇨🇴" },
            { name: "Comoros", flag: "🇰🇲" },
            { name: "Congo", flag: "🇨🇬" },
            { name: "Costa Rica", flag: "🇨🇷" },
            { name: "Croatia", flag: "🇭🇷" },
            { name: "Cuba", flag: "🇨🇺" },
            { name: "Cyprus", flag: "🇨🇾" },
            { name: "Czech Republic", flag: "🇨🇿" },
            { name: "Democratic Republic of Congo", flag: "🇨🇩" },
            { name: "Denmark", flag: "🇩🇰" },
            { name: "Djibouti", flag: "🇩🇯" },
            { name: "Dominica", flag: "🇩🇲" },
            { name: "Dominican Republic", flag: "🇩🇴" },
            { name: "East Timor", flag: "🇹🇱" },
            { name: "Ecuador", flag: "🇪🇨" },
            { name: "Egypt", flag: "🇪🇬" },
            { name: "El Salvador", flag: "🇸🇻" },
            { name: "Equatorial Guinea", flag: "🇬🇶" },
            { name: "Eritrea", flag: "🇪🇷" },
            { name: "Estonia", flag: "🇪🇪" },
            { name: "Eswatini", flag: "🇸🇿" },
            { name: "Ethiopia", flag: "🇪🇹" },
            { name: "Fiji", flag: "🇫🇯" },
            { name: "Finland", flag: "🇫🇮" },
            { name: "France", flag: "🇫🇷" },
            { name: "Gabon", flag: "🇬🇦" },
            { name: "Gambia", flag: "🇬🇲" },
            { name: "Georgia", flag: "🇬🇪" },
            { name: "Germany", flag: "🇩🇪" },
            { name: "Ghana", flag: "🇬🇭" },
            { name: "Greece", flag: "🇬🇷" },
            { name: "Grenada", flag: "🇬🇩" },
            { name: "Guatemala", flag: "🇬🇹" },
            { name: "Guinea", flag: "🇬🇳" },
            { name: "Guinea-Bissau", flag: "🇬🇼" },
            { name: "Guyana", flag: "🇬🇾" },
            { name: "Haiti", flag: "🇭🇹" },
            { name: "Honduras", flag: "🇭🇳" },
            { name: "Hungary", flag: "🇭🇺" },
            { name: "Iceland", flag: "🇮🇸" },
            { name: "India", flag: "🇮🇳" },
            { name: "Indonesia", flag: "🇮🇩" },
            { name: "Iran", flag: "🇮🇷" },
            { name: "Iraq", flag: "🇮🇶" },
            { name: "Ireland", flag: "🇮🇪" },
            { name: "Israel", flag: "🇮🇱" },
            { name: "Italy", flag: "🇮🇹" },
            { name: "Ivory Coast", flag: "🇨🇮" },
            { name: "Jamaica", flag: "🇯🇲" },
            { name: "Japan", flag: "🇯🇵" },
            { name: "Jordan", flag: "🇯🇴" },
            { name: "Kazakhstan", flag: "🇰🇿" },
            { name: "Kenya", flag: "🇰🇪" },
            { name: "Kiribati", flag: "🇰🇮" },
            { name: "Kosovo", flag: "🇽🇰" },
            { name: "Kuwait", flag: "🇰🇼" },
            { name: "Kyrgyzstan", flag: "🇰🇬" },
            { name: "Laos", flag: "🇱🇦" },
            { name: "Latvia", flag: "🇱🇻" },
            { name: "Lebanon", flag: "🇱🇧" },
            { name: "Lesotho", flag: "🇱🇸" },
            { name: "Liberia", flag: "🇱🇷" },
            { name: "Libya", flag: "🇱🇾" },
            { name: "Liechtenstein", flag: "🇱🇮" },
            { name: "Lithuania", flag: "🇱🇹" },
            { name: "Luxembourg", flag: "🇱🇺" },
            { name: "Madagascar", flag: "🇲🇬" },
            { name: "Malawi", flag: "🇲🇼" },
            { name: "Malaysia", flag: "🇲🇾" },
            { name: "Maldives", flag: "🇲🇻" },
            { name: "Mali", flag: "🇲🇱" },
            { name: "Malta", flag: "🇲🇹" },
            { name: "Marshall Islands", flag: "🇲🇭" },
            { name: "Mauritania", flag: "🇲🇷" },
            { name: "Mauritius", flag: "🇲🇺" },
            { name: "Mexico", flag: "🇲🇽" },
            { name: "Micronesia", flag: "🇫🇲" },
            { name: "Moldova", flag: "🇲🇩" },
            { name: "Monaco", flag: "🇲🇨" },
            { name: "Mongolia", flag: "🇲🇳" },
            { name: "Montenegro", flag: "🇲🇪" },
            { name: "Morocco", flag: "🇲🇦" },
            { name: "Mozambique", flag: "🇲🇿" },
            { name: "Myanmar", flag: "🇲🇲" },
            { name: "Namibia", flag: "🇳🇦" },
            { name: "Nauru", flag: "🇳🇷" },
            { name: "Nepal", flag: "🇳🇵" },
            { name: "Netherlands", flag: "🇳🇱" },
            { name: "New Zealand", flag: "🇳🇿" },
            { name: "Nicaragua", flag: "🇳🇮" },
            { name: "Niger", flag: "🇳🇪" },
            { name: "Nigeria", flag: "🇳🇬" },
            { name: "North Korea", flag: "🇰🇵" },
            { name: "North Macedonia", flag: "🇲🇰" },
            { name: "Norway", flag: "🇳🇴" },
            { name: "Oman", flag: "🇴🇲" },
            { name: "Pakistan", flag: "🇵🇰" },
            { name: "Palau", flag: "🇵🇼" },
            { name: "Palestine", flag: "🇵🇸" },
            { name: "Panama", flag: "🇵🇦" },
            { name: "Papua New Guinea", flag: "🇵🇬" },
            { name: "Paraguay", flag: "🇵🇾" },
            { name: "Peru", flag: "🇵🇪" },
            { name: "Philippines", flag: "🇵🇭" },
            { name: "Poland", flag: "🇵🇱" },
            { name: "Portugal", flag: "🇵🇹" },
            { name: "Qatar", flag: "🇶🇦" },
            { name: "Romania", flag: "🇷🇴" },
            { name: "Russia", flag: "🇷🇺" },
            { name: "Rwanda", flag: "🇷🇼" },
            { name: "Saint Kitts and Nevis", flag: "🇰🇳" },
            { name: "Saint Lucia", flag: "🇱🇨" },
            { name: "Saint Vincent and the Grenadines", flag: "🇻🇨" },
            { name: "Samoa", flag: "🇼🇸" },
            { name: "San Marino", flag: "🇸🇲" },
            { name: "Sao Tome and Principe", flag: "🇸🇹" },
            { name: "Saudi Arabia", flag: "🇸🇦" },
            { name: "Senegal", flag: "🇸🇳" },
            { name: "Serbia", flag: "🇷🇸" },
            { name: "Seychelles", flag: "🇸🇨" },
            { name: "Sierra Leone", flag: "🇸🇱" },
            { name: "Singapore", flag: "🇸🇬" },
            { name: "Slovakia", flag: "🇸🇰" },
            { name: "Slovenia", flag: "🇸🇮" },
            { name: "Solomon Islands", flag: "🇸🇧" },
            { name: "Somalia", flag: "🇸🇴" },
            { name: "South Africa", flag: "🇿🇦" },
            { name: "South Korea", flag: "🇰🇷" },
            { name: "South Sudan", flag: "🇸🇸" },
            { name: "Spain", flag: "🇪🇸" },
            { name: "Sri Lanka", flag: "🇱🇰" },
            { name: "Sudan", flag: "🇸🇩" },
            { name: "Suriname", flag: "🇸🇷" },
            { name: "Sweden", flag: "🇸🇪" },
            { name: "Switzerland", flag: "🇨🇭" },
            { name: "Syria", flag: "🇸🇾" },
            { name: "Taiwan", flag: "🇹🇼" },
            { name: "Tajikistan", flag: "🇹🇯" },
            { name: "Tanzania", flag: "🇹🇿" },
            { name: "Thailand", flag: "🇹🇭" },
            { name: "Togo", flag: "🇹🇬" },
            { name: "Tonga", flag: "🇹🇴" },
            { name: "Trinidad and Tobago", flag: "🇹🇹" },
            { name: "Tunisia", flag: "🇹🇳" },
            { name: "Turkey", flag: "🇹🇷" },
            { name: "Turkmenistan", flag: "🇹🇲" },
            { name: "Tuvalu", flag: "🇹🇻" },
            { name: "Uganda", flag: "🇺🇬" },
            { name: "Ukraine", flag: "🇺🇦" },
            { name: "United Arab Emirates", flag: "🇦🇪" },
            { name: "United Kingdom", flag: "🇬🇧" },
            { name: "United States", flag: "🇺🇸" },
            { name: "Uruguay", flag: "🇺🇾" },
            { name: "Uzbekistan", flag: "🇺🇿" },
            { name: "Vanuatu", flag: "🇻🇺" },
            { name: "Vatican City", flag: "🇻🇦" },
            { name: "Venezuela", flag: "🇻🇪" },
            { name: "Vietnam", flag: "🇻🇳" },
            { name: "Yemen", flag: "🇾🇪" },
            { name: "Zambia", flag: "🇿🇲" },
            { name: "Zimbabwe", flag: "🇿🇼" }
        ];

        // Firebase configuration for training-after-winning project
        const firebaseConfig = {
            apiKey: "AIzaSyB_5keKPoc3lmxolZdLZosZa9heQPBaXls",
            authDomain: "training-after-winning.firebaseapp.com",
            databaseURL: "https://training-after-winning-default-rtdb.firebaseio.com",
            projectId: "training-after-winning",
            storageBucket: "training-after-winning.appspot.com",
            messagingSenderId: "688977650774",
            appId: "1:688977650774:web:8c9f3e8f9f0e1e2e3e4e5e"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Firebase references
        const queueRef = database.ref('queue');
        const activeStudentsRef = database.ref('active_students');
        const supervisorRef = database.ref('supervisor');

        // State management
        let appState = {
            status: 'registering', // registering, waiting, active
            studentId: null,
            studentName: null,
            studentCountry: null,
            selectedCountryObj: null,
            carNumber: null,
            firebaseListeners: [],
            demoMode: false
        };

        // Expose to window for debugging/testing
        window.appState = appState;

        // Generate unique student ID
        function generateStudentId() {
            return 'STU' + Date.now() + Math.random().toString(36).substr(2, 5).toUpperCase();
        }

        // DOM Elements
        const registrationModal = document.getElementById('registrationModal');
        const waitingRoom = document.getElementById('waitingRoom');
        const controlPanel = document.getElementById('controlPanel');
        const connectionBar = document.getElementById('connectionBar');
        const connectionWarning = document.getElementById('connectionWarning');
        const countryInput = document.getElementById('studentCountry');
        const countryList = document.getElementById('countryList');

        // Country autocomplete setup
        let selectedCountryIndex = -1;

        function setupCountryAutocomplete() {
            countryInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                selectedCountryIndex = -1;

                if (searchTerm.length === 0) {
                    countryList.classList.remove('active');
                    return;
                }

                const filteredCountries = countries.filter(country =>
                    country.name.toLowerCase().includes(searchTerm)
                );

                if (filteredCountries.length > 0) {
                    displayCountryList(filteredCountries);
                    countryList.classList.add('active');
                } else {
                    countryList.classList.remove('active');
                }
            });

            countryInput.addEventListener('keydown', (e) => {
                const items = countryList.querySelectorAll('.autocomplete-item');

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedCountryIndex = Math.min(selectedCountryIndex + 1, items.length - 1);
                    updateSelectedItem(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedCountryIndex = Math.max(selectedCountryIndex - 1, -1);
                    updateSelectedItem(items);
                } else if (e.key === 'Enter' && selectedCountryIndex >= 0) {
                    e.preventDefault();
                    const selectedItem = items[selectedCountryIndex];
                    if (selectedItem) {
                        selectCountry(selectedItem.dataset.country, selectedItem.dataset.flag);
                    }
                } else if (e.key === 'Escape') {
                    countryList.classList.remove('active');
                }
            });

            countryInput.addEventListener('blur', () => {
                // Delay to allow click events on list items
                setTimeout(() => {
                    countryList.classList.remove('active');
                }, 200);
            });

            countryInput.addEventListener('focus', (e) => {
                if (e.target.value.length > 0) {
                    const searchTerm = e.target.value.toLowerCase();
                    const filteredCountries = countries.filter(country =>
                        country.name.toLowerCase().includes(searchTerm)
                    );
                    if (filteredCountries.length > 0) {
                        displayCountryList(filteredCountries);
                        countryList.classList.add('active');
                    }
                }
            });
        }

        function displayCountryList(countryArray) {
            countryList.innerHTML = '';
            countryArray.slice(0, 10).forEach((country, index) => { // Show max 10 at a time
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.dataset.country = country.name;
                item.dataset.flag = country.flag;
                item.innerHTML = `
                    <span class="country-flag">${country.flag}</span>
                    <span>${country.name}</span>
                `;
                item.addEventListener('click', () => {
                    selectCountry(country.name, country.flag);
                });
                countryList.appendChild(item);
            });
        }

        function updateSelectedItem(items) {
            items.forEach((item, index) => {
                if (index === selectedCountryIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function selectCountry(name, flag) {
            countryInput.value = name;
            appState.selectedCountryObj = { name, flag };
            countryList.classList.remove('active');
            selectedCountryIndex = -1;
        }

        // Initialize country autocomplete
        setupCountryAutocomplete();

        // Registration form handling
        document.getElementById('registrationForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('studentName').value.trim();
            const countryValue = countryInput.value.trim();
            const experience = document.getElementById('experience').value;

            if (!name || !countryValue) {
                return;
            }

            // Validate that country exists
            const countryObj = countries.find(c => c.name.toLowerCase() === countryValue.toLowerCase());
            if (!countryObj) {
                document.getElementById('countryError').style.display = 'block';
                return;
            }

            // Disable submit button
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').textContent = 'Registering...';

            // Store student info
            appState.studentId = generateStudentId();
            appState.studentName = name;
            appState.studentCountry = countryObj.name;
            appState.selectedCountryObj = countryObj;

            // Save session data
            saveSessionData();

            // Register student in Firebase
            registerStudent(name, countryObj, experience);
        });

        // Firebase registration and listeners
        async function registerStudent(name, countryObj, experience) {
            try {
                // Write to Firebase queue
                const studentData = {
                    studentId: appState.studentId,
                    name: name,
                    country: countryObj.name,
                    flag: countryObj.flag,
                    experience: experience,
                    registrationTime: firebase.database.ServerValue.TIMESTAMP,
                    status: 'waiting',
                    position: null
                };

                await queueRef.child(appState.studentId).set(studentData);

                console.log('Registered in Firebase queue');
                connectionBar.className = 'connection-bar connected';
                connectionWarning.classList.add('hidden');

                // Store student data in app state for listeners
                appState.studentData = studentData;

                // Setup listeners
                setupFirebaseListeners();

                // Show waiting room
                showWaitingRoom();

            } catch (error) {
                console.error('Firebase registration error:', error);
                connectionBar.className = 'connection-bar error';
                connectionWarning.classList.remove('hidden');
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').textContent = 'Join Waiting Room';
            }
        }

        function setupFirebaseListeners() {
            // Clean up existing listeners
            appState.firebaseListeners.forEach(ref => ref.off());
            appState.firebaseListeners = [];

            // STATE MACHINE PATTERN - Industry best practice for distributed systems
            // Single source of truth: student_states node
            const studentStateRef = firebase.database().ref(`student_states/${appState.studentId}`);

            // Initialize with PENDING state when registering
            studentStateRef.set({
                state: 'PENDING',
                timestamp: Date.now(),
                name: appState.studentData.name
            });

            // SINGLE LISTENER - No race conditions, no inference needed
            studentStateRef.on('value', (snapshot) => {
                const stateData = snapshot.val();
                if (!stateData) return;

                console.log(`Student state: ${stateData.state}`);

                // State machine transitions
                switch(stateData.state) {
                    case 'PENDING':
                        // Student is waiting for approval
                        if (appState.status !== 'waiting') {
                            showWaitingRoom();
                        }
                        break;

                    case 'APPROVED':
                        // Student was approved!
                        if (appState.status === 'waiting') {
                            console.log(`Student APPROVED! Car number: ${stateData.carNumber}`);
                            handleApproval({
                                approved: true,
                                carNumber: stateData.carNumber || 1,
                                sessionTime: 300
                            });

                        }
                        break;

                    case 'REJECTED':
                        // Student was rejected
                        if (appState.status === 'waiting') {
                            console.log(`Student REJECTED: ${stateData.reason || 'Session at capacity'}`);
                            handleRejection();
                        }
                        break;

                    default:
                        console.warn(`Unknown state: ${stateData.state}`);
                }
            });
            appState.firebaseListeners.push(studentStateRef);

            // Still listen to queue for UI updates (position in queue, etc.)
            const studentQueueRef = queueRef.child(appState.studentId);
            studentQueueRef.on('value', (snapshot) => {
                if (snapshot.val()) {
                    handleQueueUpdate(snapshot.val());
                }
            });
            appState.firebaseListeners.push(studentQueueRef);

            // Listen for all active students (to show in waiting room)
            activeStudentsRef.on('value', (snapshot) => {
                const activeStudents = snapshot.val() || {};
                updateActiveRacersFromFirebase(activeStudents);
            });
            appState.firebaseListeners.push(activeStudentsRef);

            // Listen for queue size
            queueRef.on('value', (snapshot) => {
                const queue = snapshot.val() || {};
                const queueArray = Object.values(queue);
                const waitingCount = queueArray.filter(s => s.status === 'waiting').length;
                const activeCount = queueArray.filter(s => s.status === 'active').length;

                // Find our position
                let position = '-';
                const waitingStudents = queueArray
                    .filter(s => s.status === 'waiting')
                    .sort((a, b) => a.registrationTime - b.registrationTime);

                const ourIndex = waitingStudents.findIndex(s => s.studentId === appState.studentId);
                if (ourIndex >= 0) {
                    position = ourIndex + 1;
                }

                updateQueueInfo({
                    position: position,
                    waitingCount: waitingCount,
                    activeCount: activeCount,
                    estimatedWait: position === '-' ? '-' : `${position * 5} min`
                });
            });
            appState.firebaseListeners.push(queueRef);

            // Listen for supervisor messages
            supervisorRef.child('messages').on('child_added', (snapshot) => {
                const message = snapshot.val();
                if (message && message.timestamp > Date.now() - 60000) { // Only recent messages
                    handleSupervisorMessage(message);
                }
            });
        }


        function handleQueueUpdate(data) {
            if (data.status === 'rejected') {
                alert('Your request was rejected: ' + (data.reason || 'Please try again later'));
                cleanupAndReload();
            }
        }

        function handleSupervisorMessage(message) {
            if (message.type === 'session_ending' && message.studentId === appState.studentId) {
                const remaining = message.remainingTime || 60;
                console.log(`Session ending in ${remaining} seconds`);

            }
        }

        function updateActiveRacersFromFirebase(activeStudents) {
            const racers = [];
            for (let i = 1; i <= 5; i++) {
                let racer = null;
                for (const [studentId, studentData] of Object.entries(activeStudents)) {
                    if (studentData.carNumber === i && studentData.active) {
                        racer = {
                            name: studentData.name,
                            country: studentData.country,
                            flag: studentData.flag
                        };
                        break;
                    }
                }
                racers.push(racer);
            }
            updateActiveRacers(racers);
        }

        // Cleanup and reload
        function cleanupAndReload() {
            // Remove from Firebase
            if (appState.studentId) {
                queueRef.child(appState.studentId).remove();
                activeStudentsRef.child(appState.studentId).remove();
            }

            // Clean up listeners
            appState.firebaseListeners.forEach(ref => ref.off());

            // Clear local storage
            localStorage.removeItem('racingStudentData');

            // Reload page
            setTimeout(() => location.reload(), 1000);
        }

        // Show waiting room
        function showWaitingRoom() {
            appState.status = 'waiting';
            registrationModal.classList.add('hidden');
            waitingRoom.classList.add('active');
        }

        // Handle approval from supervisor
        // Handle rejection from supervisor
        function handleRejection() {
            console.log('Student rejected by supervisor');
            appState.status = 'rejected';

            // Show beautiful rejection message
            waitingRoom.innerHTML = `
                <div class="waiting-container" style="
                    text-align: center;
                    max-width: 600px;
                    margin: 0 auto;
                    padding: 40px;
                    background: linear-gradient(135deg, rgba(30, 30, 40, 0.95), rgba(40, 40, 50, 0.95));
                    backdrop-filter: blur(10px);
                    border-radius: 20px;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                    animation: slideIn 0.5s ease-out;
                ">
                    <div style="
                        width: 100px;
                        height: 100px;
                        margin: 0 auto 30px;
                        background: linear-gradient(135deg, #ff6b6b, #ff4444);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-shadow: 0 10px 30px rgba(255, 68, 68, 0.3);
                        animation: pulse 2s ease-in-out infinite;
                    ">
                        <span style="font-size: 48px;">⚠️</span>
                    </div>

                    <h1 style="
                        font-size: 2.5em;
                        margin: 0 0 20px 0;
                        background: linear-gradient(135deg, #ff6b6b, #ff8787);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        background-clip: text;
                        font-weight: 700;
                        letter-spacing: -1px;
                    ">Session at Capacity</h1>

                    <p style="
                        font-size: 1.1em;
                        color: var(--text-tertiary);
                        margin: 0 0 30px 0;
                        line-height: 1.6;
                    ">
                        The current training session has reached maximum capacity.
                        Your application has been queued for the next available slot.
                    </p>

                    <div style="
                        background: rgba(255, 255, 255, 0.05);
                        border-radius: 15px;
                        padding: 25px;
                        margin: 30px 0;
                        border: 1px solid rgba(255, 255, 255, 0.1);
                    ">
                        <h3 style="
                            margin: 0 0 15px 0;
                            color: #00ff88;
                            font-size: 1.2em;
                            font-weight: 600;
                        ">Possible Reasons</h3>

                        <div style="
                            display: grid;
                            gap: 12px;
                            text-align: left;
                        ">
                            <div style="
                                display: flex;
                                align-items: center;
                                color: var(--text-tertiary);
                            ">
                                <span style="
                                    width: 8px;
                                    height: 8px;
                                    border-radius: 50%;
                                    background: #00ff88;
                                    margin-right: 12px;
                                    flex-shrink: 0;
                                "></span>
                                All 5 racing slots are currently occupied
                            </div>
                            <div style="
                                display: flex;
                                align-items: center;
                                color: var(--text-tertiary);
                            ">
                                <span style="
                                    width: 8px;
                                    height: 8px;
                                    border-radius: 50%;
                                    background: #00bbff;
                                    margin-right: 12px;
                                    flex-shrink: 0;
                                "></span>
                                Training session time limit reached
                            </div>
                            <div style="
                                display: flex;
                                align-items: center;
                                color: var(--text-tertiary);
                            ">
                                <span style="
                                    width: 8px;
                                    height: 8px;
                                    border-radius: 50%;
                                    background: #fbbf24;
                                    margin-right: 12px;
                                    flex-shrink: 0;
                                "></span>
                                Instructor prioritizing other participants
                            </div>
                        </div>
                    </div>

                    <div style="
                        display: flex;
                        gap: 15px;
                        justify-content: center;
                        margin-top: 40px;
                    ">
                        <button onclick="location.reload()" style="
                            padding: 15px 40px;
                            font-size: 1.1em;
                            font-weight: 600;
                            border: none;
                            border-radius: 30px;
                            background: linear-gradient(135deg, #00ff88, #00bbff);
                            color: #0a0a0a;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.2);
                        "
                        onmouseover="this.style.transform='translateY(-2px) scale(1.05)'; this.style.boxShadow='0 15px 40px rgba(0, 255, 136, 0.3)'"
                        onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 10px 30px rgba(0, 255, 136, 0.2)'">
                            Try Again
                        </button>

                        <button onclick="window.close()" style="
                            padding: 15px 40px;
                            font-size: 1.1em;
                            font-weight: 600;
                            border: 2px solid rgba(255, 255, 255, 0.2);
                            border-radius: 30px;
                            background: transparent;
                            color: var(--text-secondary);
                            cursor: pointer;
                            transition: all 0.3s ease;
                        "
                        onmouseover="this.style.borderColor='rgba(255, 255, 255, 0.4)'; this.style.color='#aaa'"
                        onmouseout="this.style.borderColor='rgba(255, 255, 255, 0.2)'; this.style.color='#888'">
                            Exit
                        </button>
                    </div>

                    <p style="
                        margin-top: 30px;
                        font-size: 0.9em;
                        color: var(--text-secondary);
                        font-style: italic;
                    ">
                        💡 Tip: Check back in a few minutes as slots may become available
                    </p>
                </div>

                <style>
                    @keyframes slideIn {
                        from {
                            opacity: 0;
                            transform: translateY(20px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }

                    @keyframes pulse {
                        0%, 100% {
                            transform: scale(1);
                        }
                        50% {
                            transform: scale(1.05);
                        }
                    }
                </style>
            `;

            // Clean up Firebase data
            if (appState.studentId) {
                queueRef.child(appState.studentId).remove();
                activeStudentsRef.child(appState.studentId).remove();
            }

            // Clear local storage after delay
            setTimeout(() => {
                localStorage.removeItem('racingStudentData');
            }, 2000);
        }

        // Handle approval from supervisor
        function handleApproval(data) {
            if (data.approved) {
                appState.status = 'active';
                appState.carNumber = data.carNumber;
                appState.locked = false; // Initialize lock status

                // Move to control panel
                waitingRoom.classList.remove('active');
                controlPanel.classList.add('active');

                document.getElementById('carNumber').textContent = data.carNumber;
                setupParameterControls();
            } else {
                alert('Your request was not approved. ' + (data.reason || 'Please try again later.'));
                location.reload();
            }
        }

        // Function to update parameter visibility (simplified for Pure Pursuit only)
        function updateStudentParameterVisibility() {
            // Pure Pursuit is always visible, no need to hide/show anything
            const selectedAlgorithm = 'pure_pursuit';
            console.log('Pure Pursuit algorithm active');
        }

        // Make function global so it can be called from HTML
        window.updateStudentParameterVisibility = updateStudentParameterVisibility;

        // Setup parameter controls
        function setupParameterControls() {
            const sliders = {
                targetSpeed: { element: document.getElementById('targetSpeedSlider'), decimals: 1 },
                minSpeed: { element: document.getElementById('minSpeedSlider'), decimals: 2 },
                maxSpeed: { element: document.getElementById('maxSpeedSlider'), decimals: 1 },
                lookahead: { element: document.getElementById('lookaheadSlider'), decimals: 1 },
                minLookahead: { element: document.getElementById('minLookaheadSlider'), decimals: 1 },
                maxLookahead: { element: document.getElementById('maxLookaheadSlider'), decimals: 1 },
                lookaheadGain: { element: document.getElementById('lookaheadGainSlider'), decimals: 1 },
                waypointTolerance: { element: document.getElementById('waypointToleranceSlider'), decimals: 1 },
                maxAngular: { element: document.getElementById('maxAngularSlider'), decimals: 1 }
            };

            // Update slider values without immediate Firebase updates
            Object.keys(sliders).forEach(key => {
                const slider = sliders[key];
                if (slider.element) {
                    // Regular input event for value updates
                    slider.element.addEventListener('input', (e) => {
                        const value = parseFloat(e.target.value);
                        document.getElementById(key + 'Value').textContent = value.toFixed(slider.decimals);
                    });

                    // Touch optimization: Prevent page scroll when touching slider
                    slider.element.addEventListener('touchstart', (e) => {
                        e.stopPropagation(); // Prevent event bubbling
                    }, { passive: true });

                    // Add visual feedback on touch
                    slider.element.addEventListener('touchstart', () => {
                        slider.element.style.transform = 'scale(1.02)';
                    });

                    slider.element.addEventListener('touchend', () => {
                        slider.element.style.transform = 'scale(1)';
                    });
                }
            });

            // Setup submit button
            setupSubmitButton();

            // Listen for lock status changes from supervisor
            listenForLockStatus();
        }

        // Setup submit button handler
        function setupSubmitButton() {
            const submitButton = document.getElementById('submitButton');
            const submitStatus = document.getElementById('submitStatus');

            if (!submitButton) return;

            submitButton.addEventListener('click', async () => {
                if (!appState.studentId || appState.locked) {
                    console.error('Cannot submit: No student ID or parameters are locked');
                    return;
                }

                // Gather parameters for Pure Pursuit
                const selectedAlgorithm = 'pure_pursuit';

                // Include all parameters
                const parameters = {
                    algorithm: selectedAlgorithm,
                    target_speed: parseFloat(document.getElementById('targetSpeedSlider').value),
                    min_speed: parseFloat(document.getElementById('minSpeedSlider').value),
                    max_speed: parseFloat(document.getElementById('maxSpeedSlider').value),
                    max_angular_velocity: parseFloat(document.getElementById('maxAngularSlider').value),
                    // Pure Pursuit parameters
                    lookahead_distance: parseFloat(document.getElementById('lookaheadSlider').value),
                    lookahead: parseFloat(document.getElementById('lookaheadSlider').value), // Compatibility
                    min_lookahead: parseFloat(document.getElementById('minLookaheadSlider').value),
                    max_lookahead: parseFloat(document.getElementById('maxLookaheadSlider').value),
                    lookahead_gain: parseFloat(document.getElementById('lookaheadGainSlider').value),
                    waypoint_tolerance: parseFloat(document.getElementById('waypointToleranceSlider').value)
                };

                // Visual feedback
                submitButton.disabled = true;
                submitButton.innerHTML = '⏳ Submitting...';
                submitButton.style.background = 'linear-gradient(135deg, #fbbf24, #f59e0b)';
                submitStatus.textContent = '';

                try {
                    // Update Firebase with new parameters
                    const updates = {};
                    updates[`active_students/${appState.studentId}/parameters`] = parameters;
                    updates[`active_students/${appState.studentId}/lastSubmission`] = Date.now();

                    await firebase.database().ref().update(updates);

                    // Success feedback
                    submitButton.innerHTML = '✅ Submitted!';
                    submitButton.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    submitStatus.textContent = 'Parameters submitted successfully!';
                    submitStatus.style.color = '#00ff88';

                    // Reset button after 2 seconds
                    setTimeout(() => {
                        submitButton.disabled = false;
                        submitButton.innerHTML = '📤 Submit Parameters';
                        submitButton.style.background = 'linear-gradient(135deg, #00ff88, #00bbff)';
                    }, 2000);

                    // Clear status after 5 seconds
                    setTimeout(() => {
                        submitStatus.textContent = '';
                    }, 5000);

                } catch (error) {
                    console.error('Error submitting parameters:', error);
                    submitButton.innerHTML = '❌ Failed';
                    submitButton.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    submitStatus.textContent = 'Submission failed. Please try again.';
                    submitStatus.style.color = '#ff4444';

                    setTimeout(() => {
                        submitButton.disabled = false;
                        submitButton.innerHTML = '📤 Submit Parameters';
                        submitButton.style.background = 'linear-gradient(135deg, #00ff88, #00bbff)';
                    }, 2000);
                }
            });
        }

        // Listen for lock status changes from supervisor
        function listenForLockStatus() {
            if (!appState.studentId) return;

            const studentRef = firebase.database().ref(`active_students/${appState.studentId}`);
            studentRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                const isLocked = data.locked === true;
                const submitButton = document.getElementById('submitButton');
                const lockStatus = document.getElementById('lockStatus');
                const algorithmSelect = document.getElementById('algorithmSelect');
                const sliders = [
                    'kpSlider', 'kiSlider', 'kdSlider',
                    'targetSpeedSlider', 'minSpeedSlider', 'maxSpeedSlider',
                    'lookaheadSlider', 'minLookaheadSlider', 'maxLookaheadSlider',
                    'lookaheadGainSlider', 'waypointToleranceSlider', 'maxAngularSlider'
                ];

                appState.locked = isLocked;

                if (isLocked) {
                    // Show lock overlay
                    showLockOverlay();

                    // Update UI elements
                    if (lockStatus) lockStatus.style.display = 'block';
                    if (submitButton) {
                        submitButton.disabled = true;
                        submitButton.innerHTML = '🔒 Locked by Supervisor';
                        submitButton.style.background = 'linear-gradient(135deg, #6b7280, #4b5563)';
                    }

                    // Disable all controls
                    sliders.forEach(id => {
                        const slider = document.getElementById(id);
                        if (slider) slider.disabled = true;
                    });
                    if (algorithmSelect) algorithmSelect.disabled = true;

                } else {
                    // Hide lock overlay
                    hideLockOverlay();

                    // Update UI elements
                    if (lockStatus) lockStatus.style.display = 'none';
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = '📤 Submit Parameters';
                        submitButton.style.background = 'linear-gradient(135deg, #00ff88, #00bbff)';
                    }

                    // Enable all controls
                    sliders.forEach(id => {
                        const slider = document.getElementById(id);
                        if (slider) slider.disabled = false;
                    });
                    if (algorithmSelect) algorithmSelect.disabled = false;
                }

                // Update algorithm selection if changed by supervisor
                if (data.parameters && data.parameters.algorithm && algorithmSelect) {
                    algorithmSelect.value = data.parameters.algorithm;
                    updateStudentParameterVisibility(); // Update visible parameter sections
                }

                // Update all parameter sliders if changed by supervisor
                if (data.parameters) {
                    const params = data.parameters;

                    // Update common parameters (all algorithms)
                    if (params.target_speed !== undefined) {
                        const slider = document.getElementById('targetSpeedSlider');
                        const display = document.getElementById('targetSpeedValue');
                        if (slider) {
                            slider.value = params.target_speed;
                            if (display) display.textContent = params.target_speed.toFixed(1);
                        }
                    }

                    if (params.min_speed !== undefined) {
                        const slider = document.getElementById('minSpeedSlider');
                        const display = document.getElementById('minSpeedValue');
                        if (slider) {
                            slider.value = params.min_speed;
                            if (display) display.textContent = params.min_speed.toFixed(2);
                        }
                    }

                    if (params.max_speed !== undefined) {
                        const slider = document.getElementById('maxSpeedSlider');
                        const display = document.getElementById('maxSpeedValue');
                        if (slider) {
                            slider.value = params.max_speed;
                            if (display) display.textContent = params.max_speed.toFixed(1);
                        }
                    }

                    if (params.max_angular_velocity !== undefined) {
                        const slider = document.getElementById('maxAngularSlider');
                        const display = document.getElementById('maxAngularValue');
                        if (slider) {
                            slider.value = params.max_angular_velocity;
                            if (display) display.textContent = params.max_angular_velocity.toFixed(1);
                        }
                    }

                    // Update Pure Pursuit parameters
                    if (params.lookahead_distance !== undefined || params.lookahead !== undefined) {
                        const value = params.lookahead_distance || params.lookahead;
                        const slider = document.getElementById('lookaheadSlider');
                        const display = document.getElementById('lookaheadValue');
                        if (slider) {
                            slider.value = value;
                            if (display) display.textContent = value.toFixed(1);
                        }
                    }

                    if (params.min_lookahead !== undefined) {
                        const slider = document.getElementById('minLookaheadSlider');
                        const display = document.getElementById('minLookaheadValue');
                        if (slider) {
                            slider.value = params.min_lookahead;
                            if (display) display.textContent = params.min_lookahead.toFixed(1);
                        }
                    }

                    if (params.max_lookahead !== undefined) {
                        const slider = document.getElementById('maxLookaheadSlider');
                        const display = document.getElementById('maxLookaheadValue');
                        if (slider) {
                            slider.value = params.max_lookahead;
                            if (display) display.textContent = params.max_lookahead.toFixed(1);
                        }
                    }

                    if (params.lookahead_gain !== undefined) {
                        const slider = document.getElementById('lookaheadGainSlider');
                        const display = document.getElementById('lookaheadGainValue');
                        if (slider) {
                            slider.value = params.lookahead_gain;
                            if (display) display.textContent = params.lookahead_gain.toFixed(1);
                        }
                    }

                    if (params.waypoint_tolerance !== undefined) {
                        const slider = document.getElementById('waypointToleranceSlider');
                        const display = document.getElementById('waypointToleranceValue');
                        if (slider) {
                            slider.value = params.waypoint_tolerance;
                            if (display) display.textContent = params.waypoint_tolerance.toFixed(1);
                        }
                    }

                    // Update PID parameters
                    if (params.kp !== undefined) {
                        const slider = document.getElementById('kpSlider');
                        const display = document.getElementById('kpValue');
                        if (slider) {
                            slider.value = params.kp;
                            if (display) display.textContent = params.kp.toFixed(1);
                        }
                    }

                    if (params.ki !== undefined) {
                        const slider = document.getElementById('kiSlider');
                        const display = document.getElementById('kiValue');
                        if (slider) {
                            slider.value = params.ki;
                            if (display) display.textContent = params.ki.toFixed(2);
                        }
                    }

                    if (params.kd !== undefined) {
                        const slider = document.getElementById('kdSlider');
                        const display = document.getElementById('kdValue');
                        if (slider) {
                            slider.value = params.kd;
                            if (display) display.textContent = params.kd.toFixed(2);
                        }
                    }

                    // Update Stanley parameters
                    if (params.stanley_gain !== undefined) {
                        const slider = document.getElementById('stanleyGainSlider');
                        const display = document.getElementById('stanleyGainValue');
                        if (slider) {
                            slider.value = params.stanley_gain;
                            if (display) display.textContent = params.stanley_gain.toFixed(1);
                        }
                    }

                    if (params.stanley_soft_gain !== undefined) {
                        const slider = document.getElementById('stanleySoftGainSlider');
                        const display = document.getElementById('stanleySoftGainValue');
                        if (slider) {
                            slider.value = params.stanley_soft_gain;
                            if (display) display.textContent = params.stanley_soft_gain.toFixed(1);
                        }
                    }

                    // Visual feedback that parameters were updated
                    const submitStatus = document.getElementById('submitStatus');
                    if (submitStatus) {
                        submitStatus.textContent = '📥 Parameters updated by Supervisor';
                        submitStatus.style.color = '#fbbf24';
                        setTimeout(() => {
                            submitStatus.textContent = '';
                        }, 3000);
                    }
                }
            });
        }

        // Show lock overlay
        function showLockOverlay() {
            // Remove existing overlay if present
            const existing = document.querySelector('.lock-overlay');
            if (existing) return;

            const lockOverlay = document.createElement('div');
            lockOverlay.className = 'lock-overlay active';
            lockOverlay.innerHTML = `
                <div class="lock-message">
                    <div class="lock-icon">🔒</div>
                    <div class="lock-text">Parameters Locked by Supervisor</div>
                    <div class="lock-subtext">No changes allowed until supervisor unlocks</div>
                </div>
            `;
            document.getElementById('controlPanel').appendChild(lockOverlay);
        }

        // Hide lock overlay
        function hideLockOverlay() {
            const overlay = document.querySelector('.lock-overlay');
            if (overlay) {
                overlay.remove();
            }
        }


        // Update queue information
        function updateQueueInfo(data) {
            // Check if elements exist before updating (they might be replaced during rejection)
            const queuePos = document.getElementById('queuePosition');
            const waitingCnt = document.getElementById('waitingCount');
            const activeCnt = document.getElementById('activeCount');
            const estWait = document.getElementById('estimatedWait');

            if (queuePos) queuePos.textContent = data.position || '-';
            if (waitingCnt) waitingCnt.textContent = data.waitingCount || 0;
            if (activeCnt) activeCnt.textContent = data.activeCount || 0;
            if (estWait) estWait.textContent = data.estimatedWait || '-';
        }

        // Update active racers display
        function updateActiveRacers(racers) {
            racers.forEach((racer, index) => {
                const card = document.querySelector(`[data-car="${index + 1}"]`);
                if (card) {
                    if (racer) {
                        card.classList.remove('empty');
                        card.classList.add('active');
                        card.querySelector('.racer-name').textContent = racer.name;
                        card.querySelector('.racer-country').textContent = `${racer.flag} ${racer.country}`;
                    } else {
                        card.classList.add('empty');
                        card.classList.remove('active');
                        card.querySelector('.racer-name').textContent = `Car ${index + 1}`;
                        card.querySelector('.racer-country').textContent = 'Empty';
                    }
                }
            });
        }


        // Initialize connection bar
        connectionBar.className = 'connection-bar connecting';

        // Check for existing session on page load
        window.addEventListener('load', () => {
            // Display deployment timestamp
            const deployTime = new Date();
            const updateTimeElement = document.getElementById('updateTime');
            if (updateTimeElement) {
                const timeString = deployTime.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                updateTimeElement.textContent = timeString;
            }

            const savedData = localStorage.getItem('racingStudentData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    appState.studentId = data.studentId;
                    appState.studentName = data.name;
                    appState.studentCountry = data.country;
                    appState.selectedCountryObj = data.selectedCountryObj;

                    // Check if still in queue or active
                    queueRef.child(appState.studentId).once('value', (snapshot) => {
                        const queueData = snapshot.val();
                        if (queueData) {
                            setupFirebaseListeners();
                            showWaitingRoom();
                            connectionBar.className = 'connection-bar connected';
                        } else {
                            // Check if active
                            activeStudentsRef.child(appState.studentId).once('value', (snapshot) => {
                                const activeData = snapshot.val();
                                if (activeData && activeData.active) {
                                    setupFirebaseListeners();
                                    handleApproval({
                                        approved: true,
                                        carNumber: activeData.carNumber,
                                        sessionTime: 300
                                    });
                                    connectionBar.className = 'connection-bar connected';
                                } else {
                                    // Session expired
                                    localStorage.removeItem('racingStudentData');
                                }
                            });
                        }
                    });
                } catch (error) {
                    console.error('Error loading saved session:', error);
                    localStorage.removeItem('racingStudentData');
                }
            }

            // Setup connection monitoring
            database.ref('.info/connected').on('value', (snapshot) => {
                const connected = snapshot.val();
                if (connected) {
                    connectionBar.className = 'connection-bar connected';
                    connectionWarning.classList.add('hidden');
                } else {
                    connectionBar.className = 'connection-bar error';
                    connectionWarning.classList.remove('hidden');
                }
            });
        });

        // Save session data when registering
        function saveSessionData() {
            if (appState.studentId) {
                localStorage.setItem('racingStudentData', JSON.stringify({
                    studentId: appState.studentId,
                    name: appState.studentName,
                    country: appState.studentCountry,
                    selectedCountryObj: appState.selectedCountryObj
                }));
            }
        }
    </script>
</body>
</html>